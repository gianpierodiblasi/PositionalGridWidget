TW.Runtime.Widgets.positionalgrid=function(){var e=this,p=(new Date).getTime()+"_"+Math.floor(1E3*Math.random()),d=[],f=[],g,l=[],k,m=!1,h=-1,n;this.runtimeProperties=function(){return{supportsAutoResize:!0,needsDataLoadingAndError:!1}};this.renderHtml=function(){return'<div class="widget-content widget-positionalgrid widget-positionalgrid-'+p+'">  <canvas class="widget-positionalgrid-canvas widget-positionalgrid-canvas-'+p+'"></canvas></div>'};this.afterRender=function(){e.getProperty("debugMode");
var b=e.getProperty("rowSelection"),a=$(".widget-positionalgrid-"+p)[0];(new ResizeObserver(e.draw)).observe(a);var d=$(".widget-positionalgrid-canvas-"+p)[0];d.onmousemove=function(c){if(m){var a=e.getProperty("editedData");a.rows[h].centerX=(c.pageX-n.left-g.x)/k;a.rows[h].centerY=(c.pageY-n.top-g.y)/k;e.setProperty("editedData",TW.InfoTableUtilities.CloneInfoTable({dataShape:a.dataShape,rows:a.rows}));e.draw()}else{h=-1;d.style.cursor="default";var r=e.getProperty("editPositions");if(r||"None"!==
b){a=e.getProperty("data");for(var f=0;f<a.rows.length;f++)l[a.rows[f].id].top<=c.offsetY&&c.offsetY<=l[a.rows[f].id].bottom&&l[a.rows[f].id].left<=c.offsetX&&c.offsetX<=l[a.rows[f].id].right&&(h=f,d.style.cursor=r?"move":"pointer")}}};d.onmousedown=function(a){if(-1!==h)if(e.getProperty("editPositions"))g&&l.length&&(m=!0,n=a.target.getBoundingClientRect());else if("Single"===b)f=[],f[h]=!0,e.updateSelection("data",[h]),e.draw();else if("Multiple"===b){f[h]=!f[h];a=[];for(var c=0;c<f.length;c++)f[c]&&
a.push(c);e.updateSelection("data",a);e.draw()}};d.onmouseup=function(a){m=!1};d.ondblclick=function(a){-1!==h&&!e.getProperty("editPositions")&&g&&l.length&&e.jqElement.triggerHandler("DoubleClicked")};this.loadImages()};this.serviceInvoked=function(b){};this.handleSelectionUpdate=function(b,a,d){if("data"===b){f=[];if(d)for(b=0;b<d.length;b++)f[d[b]]=!0;this.draw()}};this.updateProperty=function(b){if("data"===b.TargetProperty){this.setProperty("data",b.RawSinglePropertyValue);this.setProperty("editedData",
TW.InfoTableUtilities.CloneInfoTable({dataShape:b.RawSinglePropertyValue.dataShape,rows:b.RawSinglePropertyValue.rows}));var a=e.getProperty("data");e.getProperty("debugMode")&&(console.log("PositionalGrid - infotable = "),console.log(a));f=[];if(b.SelectedRowIndices)for(a=0;a<b.SelectedRowIndices.length;a++)f[b.SelectedRowIndices[a]]=!0;this.loadImages()}else"background"===b.TargetProperty?(this.setProperty("background",b.RawSinglePropertyValue),this.loadImages()):"editPositions"===b.TargetProperty&&
this.setProperty("editPositions",b.RawSinglePropertyValue)};this.loadImages=function(){var b=e.getProperty("background"),a=e.getProperty("data"),f=e.getProperty("debugMode");if(b&&!d[b])f&&console.log("PositionalGrid - loading background = "+b),d[b]=new Image,d[b].onload=e.loadImages,d[b].onerror=function(){var a="PositionalGrid - unabled to load the background = "+b;TW.log.error(a);console.error(a)},d[b].src=b;else{if(a)for(var c=0;c<a.rows.length;c++){if(a.rows[c].image&&!d[a.rows[c].image]){f&&
console.log("PositionalGrid - loading image = "+a.rows[c].image);d[a.rows[c].image]=new Image;d[a.rows[c].image].onload=e.loadImages;d[a.rows[c].image].onerror=function(){var b="PositionalGrid - unabled to load the image = "+a.rows[c].image;TW.log.error(b);console.error(b)};d[a.rows[c].image].src=a.rows[c].image;return}if(a.rows[c].selectedImage&&!d[a.rows[c].selectedImage]){f&&console.log("PositionalGrid - loading selectedImage = "+a.rows[c].selectedImage);d[a.rows[c].selectedImage]=new Image;d[a.rows[c].selectedImage].onload=
e.loadImages;d[a.rows[c].selectedImage].onerror=function(){var b="PositionalGrid - unabled to load the selectedImage = "+a.rows[c].selectedImage;TW.log.error(b);console.error(b)};d[a.rows[c].selectedImage].src=a.rows[c].selectedImage;return}}e.draw()}};this.draw=function(){var b=e.getProperty("background"),a=e.getProperty("editedData");g=null;l=[];var h=$(".widget-positionalgrid-"+p)[0],c=$(".widget-positionalgrid-canvas-"+p)[0];if(b&&(c.width=h.offsetWidth,c.height=h.offsetHeight,h=c.getContext("2d"),
k=Math.min(c.width/d[b].width,c.height/d[b].height),g={w:k*d[b].width,h:k*d[b].height},g.x=c.width>g.w?(c.width-g.w)/2:0,g.y=c.height>g.h?(c.height-g.h)/2:0,h.drawImage(d[b],g.x,g.y,g.w,g.h),a))for(b=0;b<a.rows.length;b++){c=k*d[a.rows[b].image].width;var m=k*d[a.rows[b].image].height,n=g.x+k*a.rows[b].centerX-c/2,q=g.y+k*a.rows[b].centerY-m/2;h.drawImage(f[b]&&a.rows[b].selectedImage?d[a.rows[b].selectedImage]:d[a.rows[b].image],n,q,c,m);l[a.rows[b].id]={top:q,left:n,bottom:q+m,right:n+c}}}};